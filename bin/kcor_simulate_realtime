#!/usr/bin/env python

import argparse
import logging
import subprocess
import time


# setup the logging mechanism
logging.basicConfig(format='%(asctime)s %(message)s',
                    datefmt='%Y-%m-%d %H:%M:%S',
                    level=logging.DEBUG)


def launch_loop(date, config_flags, frequency):
    logging.info('starting KCor realtime runner...')
    logging.info('config flags  : %s', config_flags)
    logging.info('frequency     : %d minutes', frequency)

    launch_cmd = ['runkcor_rt.sh', date, config_flags]

    while True:
        pid = subprocess.Popen(launch_cmd).pid
        logging.info('launched KCor realtime pipeline with pid %d', pid)
        time.sleep(60.0 * frequency)


if __name__ == '__main__':
    name = 'Realtime KCor pipeline runner'
    parser = argparse.ArgumentParser(description=name)
    config_flags_help = '''FLAGS section of config filename'''
    date_help = '''date to run on'''
    parser.add_argument('date', type=str, help=date_help)
    parser.add_argument('config_flags', type=str, help=config_flags_help)
    frequency_help = '''number of minutes between launches of realtime
                        pipeline, default is 10 minutes'''
    parser.add_argument('-f', '--frequency',
                        type=int,
                        help=frequency_help,
                        default=10)
    args = parser.parse_args()

    try:
        launch_loop(args.date, args.config_flags, args.frequency)
    except KeyboardInterrupt:
        logging.info('quitting...')
